<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI åŠŸèƒ½æç®€æµ‹è¯•</title>
    <style>
        body { font-family: sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; position: relative; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 8px; }
        #chat-history { height: 400px; overflow-y: auto; border: 1px solid #eee; padding: 10px; background: #f9f9f9; }
        .message { margin-bottom: 10px; padding: 8px; border-radius: 4px; }
        .user { background: #e3f2fd; text-align: right; }
        .assistant { background: #fff; border: 1px solid #ddd; }
        .card { border: 1px dashed #ff9800; background: #fff3e0; padding: 5px; margin-top: 5px; font-size: 0.9em; }
        .controls { display: flex; gap: 10px; margin-top: 10px; }
        input { flex: 1; padding: 8px; }
        button { padding: 8px 15px; cursor: pointer; }
        
        /* Modal Styles */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
        .modal { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 8px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body label { display: block; margin-bottom: 5px; font-weight: bold; }
        .modal-body input[type="text"], .modal-body textarea, .modal-body select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .modal-body textarea { height: 80px; resize: vertical; }
        .modal-body .checkbox-group { display: flex; align-items: center; gap: 10px; }
        .modal-body .checkbox-group input { width: auto; flex: 0; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px; padding-top: 10px; border-top: 1px solid #eee; }
    </style>
</head>
<body>
    <button onclick="openSettingsModal()" style="position: absolute; top: 20px; right: 20px;">âš™ï¸ è®¾ç½®</button>
    <h1>AI åŠ©æ‰‹æµ‹è¯•å°</h1>
    
    <div class="box">
        <h3>1. é…ç½®</h3>
        <label>User ID: <input type="number" id="userId" value="1"></label>
        <button onclick="loadConfig()">åŠ è½½é…ç½®</button>
        <button onclick="createDialogue()">æ–°å»ºå¯¹è¯</button>
        <button onclick="simulateCards()">æµ‹è¯•å¡ç‰‡æ˜¾ç¤º</button>
        
        <div style="margin-top: 10px; border-top: 1px dashed #ccc; padding-top: 10px;">
            <label>è¾“å…¥å¯¹è¯ID: <input type="number" id="inputDialogueId" placeholder="ä¾‹å¦‚: 12"></label>
            <button onclick="enterDialogue()">è¿›å…¥å¯¹è¯</button>
        </div>
        
        <div style="margin-top: 5px;">
            <span id="dialogueInfo">å½“å‰å¯¹è¯ID: -</span>
        </div>
    </div>

    <div class="box">
        <h3>2. å¯¹è¯</h3>
        <div id="chat-history"></div>
        <div class="controls">
            <input type="text" id="userInput" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šå¸®æˆ‘åˆ›å»ºä¸€ä¸ªæ˜å¤©ä¸Šåˆ9ç‚¹çš„èƒŒå•è¯ä»»åŠ¡">
            <button onclick="sendMessage()">å‘é€</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3>AI è®¾ç½®</h3>
                <button onclick="closeSettingsModal()" style="background:none; border:none; font-size:1.5em; padding:0; cursor:pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>API Key:</label>
                    <input type="text" id="cfg_api_key" placeholder="sk-...">
                </div>
                <div class="form-group">
                    <label>Model:</label>
                    <input type="text" id="cfg_model" placeholder="ä¾‹å¦‚: qwen-flash">
                </div>
                <div class="form-group">
                    <label>System Prompt:</label>
                    <textarea id="cfg_prompt" placeholder="ç³»ç»Ÿæç¤ºè¯"></textarea>
                </div>
                <div class="form-group">
                    <label>Character (äººè®¾):</label>
                    <select id="cfg_character">
                        <option value="é»˜è®¤">é»˜è®¤</option>
                        <option value="æ¸©æŸ”">æ¸©æŸ”</option>
                        <option value="æ­£å¼">æ­£å¼</option>
                        <option value="å¹½é»˜">å¹½é»˜</option>
                        <option value="ä¸¥å‰">ä¸¥å‰</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Long Term Memory (é•¿æœŸè®°å¿†):</label>
                    <textarea id="cfg_long_term_memory" placeholder="é•¿æœŸè®°å¿†å†…å®¹"></textarea>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="cfg_is_enable_prompt">
                    <label for="cfg_is_enable_prompt">å¯ç”¨ Prompt</label>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="cfg_auto_create">
                    <label for="cfg_auto_create">è‡ªåŠ¨ç¡®è®¤åˆ›å»ºè¯·æ±‚</label>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="cfg_auto_update">
                    <label for="cfg_auto_update">è‡ªåŠ¨ç¡®è®¤æ›´æ–°è¯·æ±‚</label>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="cfg_auto_delete">
                    <label for="cfg_auto_delete">è‡ªåŠ¨ç¡®è®¤åˆ é™¤è¯·æ±‚</label>
                </div>
                <div class="form-group checkbox-group">
                    <input type="checkbox" id="cfg_auto_reminder">
                    <label for="cfg_auto_reminder">è‡ªåŠ¨ç¡®è®¤æé†’è¯·æ±‚</label>
                </div>
            </div>
            <div class="modal-footer">
                <button onclick="closeSettingsModal()" style="background:#eee; color:#333;">å–æ¶ˆ</button>
                <button onclick="saveSettings()" style="background:#4CAF50; color:white;">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script>
        // Modal Logic
        async function openSettingsModal() {
            const uid = document.getElementById('userId').value;
            const modal = document.getElementById('settingsModal');
            
            // Show loading state or fetch data
            try {
                const res = await fetch(`${API_BASE}/ai/config/${uid}`);
                if (!res.ok) throw new Error("æ— æ³•è·å–é…ç½®");
                const data = await res.json();
                
                // Populate form
                document.getElementById('cfg_api_key').value = data.api_key || '';
                document.getElementById('cfg_model').value = data.model || '';
                document.getElementById('cfg_prompt').value = data.prompt || '';
                document.getElementById('cfg_character').value = data.character || '';
                document.getElementById('cfg_long_term_memory').value = data.long_term_memory || '';
                
                document.getElementById('cfg_is_enable_prompt').checked = data.is_enable_prompt === 1;
                document.getElementById('cfg_auto_create').checked = data.is_auto_confirm_create_request === 1;
                document.getElementById('cfg_auto_update').checked = data.is_auto_confirm_update_request === 1;
                document.getElementById('cfg_auto_delete').checked = data.is_auto_confirm_delete_request === 1;
                document.getElementById('cfg_auto_reminder').checked = data.is_auto_confirm_create_reminder === 1;
                
                modal.style.display = 'block';
            } catch (e) {
                alert("åŠ è½½è®¾ç½®å¤±è´¥: " + e);
            }
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        async function saveSettings() {
            const uid = document.getElementById('userId').value;
            
            const payload = {
                api_key: document.getElementById('cfg_api_key').value,
                model: document.getElementById('cfg_model').value,
                prompt: document.getElementById('cfg_prompt').value,
                character: document.getElementById('cfg_character').value,
                long_term_memory: document.getElementById('cfg_long_term_memory').value,
                is_enable_prompt: document.getElementById('cfg_is_enable_prompt').checked ? 1 : 0,
                is_auto_confirm_create_request: document.getElementById('cfg_auto_create').checked ? 1 : 0,
                is_auto_confirm_update_request: document.getElementById('cfg_auto_update').checked ? 1 : 0,
                is_auto_confirm_delete_request: document.getElementById('cfg_auto_delete').checked ? 1 : 0,
                is_auto_confirm_create_reminder: document.getElementById('cfg_auto_reminder').checked ? 1 : 0
            };
            
            try {
                const res = await fetch(`${API_BASE}/ai/config/${uid}`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                if (!res.ok) throw new Error("ä¿å­˜å¤±è´¥");
                
                const data = await res.json();
                alert("è®¾ç½®ä¿å­˜æˆåŠŸ!");
                closeSettingsModal();
            } catch (e) {
                alert("ä¿å­˜å¤±è´¥: " + e);
            }
        }

        let currentDialogueId = null;
        const API_BASE = "http://localhost:8000/api/v1";

        async function loadConfig() {
            const uid = document.getElementById('userId').value;
            try {
                const res = await fetch(`${API_BASE}/ai/config/${uid}`);
                const data = await res.json();
                alert("é…ç½®åŠ è½½æˆåŠŸ: " + JSON.stringify(data));
            } catch (e) {
                alert("åŠ è½½é…ç½®å¤±è´¥: " + e);
            }
        }

        async function createDialogue() {
            const uid = document.getElementById('userId').value;
            try {
                const res = await fetch(`${API_BASE}/ai/dialogues`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: parseInt(uid), title: "æµ‹è¯•å¯¹è¯ " + new Date().toLocaleTimeString() })
                });
                const data = await res.json();
                currentDialogueId = data.id;
                document.getElementById('dialogueInfo').textContent = "å½“å‰å¯¹è¯ID: " + currentDialogueId;
                
                // æ¸…ç©ºå¹¶æç¤º
                document.getElementById('chat-history').innerHTML = '';
                addMessage('system', `å¯¹è¯å·²åˆ›å»º (ID: ${currentDialogueId})`);
            } catch (e) {
                alert("åˆ›å»ºå¯¹è¯å¤±è´¥: " + e);
            }
        }

        async function enterDialogue() {
            const uid = document.getElementById('userId').value;
            const didInput = document.getElementById('inputDialogueId').value;
            
            if (!didInput) {
                alert("è¯·è¾“å…¥å¯¹è¯ID");
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/ai/dialogues/${didInput}?user_id=${uid}`);
                if (!res.ok) throw new Error("å¯¹è¯ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®");
                
                const data = await res.json();
                currentDialogueId = data.id;
                document.getElementById('dialogueInfo').textContent = "å½“å‰å¯¹è¯ID: " + currentDialogueId;
                
                // æ¸…ç©ºç°æœ‰æ¶ˆæ¯
                document.getElementById('chat-history').innerHTML = '';
                addMessage('system', `å·²è¿›å…¥å¯¹è¯ (ID: ${currentDialogueId}) - ${data.title || 'æ— æ ‡é¢˜'}`);
                
                // åŠ è½½å†å²æ¶ˆæ¯
                if (data.messages && Array.isArray(data.messages)) {
                    data.messages.forEach(turn => {
                        // turn æ˜¯ä¸€ä¸ªåˆ—è¡¨ [user_msg, assistant_msg]
                        if (Array.isArray(turn)) {
                            turn.forEach(msg => {
                                if (msg.role === 'user') {
                                    addMessage('user', msg.content);
                                } else if (msg.role === 'assistant') {
                                    const msgDiv = addMessage('assistant', '');
                                    // æ¸²æŸ“ assistant å†…å®¹ï¼ˆå¯èƒ½æ˜¯å­—ç¬¦ä¸²æˆ–æ•°ç»„ï¼‰
                                    renderAssistantContent(msg.content, msgDiv);
                                }
                            });
                        }
                    });
                }
                
            } catch (e) {
                alert("è¿›å…¥å¯¹è¯å¤±è´¥: " + e);
            }
        }
        
        function renderAssistantContent(content, msgDiv) {
            if (typeof content === 'string') {
                // ç®€å•æ–‡æœ¬
                handleEvent('partial_text', { content: content }, msgDiv);
            } else if (Array.isArray(content)) {
                // æ··åˆå†…å®¹ [{"type": 0, "data":...}, {"type": 1, ...}]
                // å¤ç”¨ handleEvent çš„é€»è¾‘ï¼Œæ¨¡æ‹Ÿäº‹ä»¶æµ
                content.forEach(item => {
                    if (item.type === 0) {
                        handleEvent('partial_text', { content: item.data.content }, msgDiv);
                    } else {
                        handleEvent('cards', { cards: [item] }, msgDiv);
                    }
                });
            }
        }

        async function sendMessage() {
            const uid = document.getElementById('userId').value;
            const text = document.getElementById('userInput').value;
            if (!text || !currentDialogueId) {
                alert("è¯·å…ˆåˆ›å»ºå¯¹è¯å¹¶è¾“å…¥å†…å®¹");
                return;
            }

            addMessage('user', text);
            document.getElementById('userInput').value = '';

            // å»ºç«‹ SSE è¿æ¥
            // æ³¨æ„ï¼šfetchEventSource æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œä½†åŸç”Ÿ EventSource åªèƒ½ç”¨ GETã€‚
            // æˆ‘ä»¬çš„åç«¯æ¥å£æ˜¯ POSTã€‚
            // æ‰€ä»¥æˆ‘ä»¬éœ€è¦ç”¨ fetch-event-source åº“ï¼Œæˆ–è€…åç«¯æ”¹ä¸º GETã€‚
            // ä½†åç«¯ç›®å‰æ˜¯ POSTã€‚
            // ä¸ºäº†æç®€æµ‹è¯•ï¼Œè¿™é‡Œæˆ‘ä»¬æ‰‹å†™ä¸€ä¸ªç®€å•çš„ fetch reader æ¨¡æ‹Ÿ SSE å®¢æˆ·ç«¯ï¼Œ
            // æˆ–è€…å¼•å…¥å¾®è½¯çš„ fetch-event-source åº“ã€‚
            // ç®€å•çš„ fetch stream reader:
            
            try {
                const response = await fetch(`${API_BASE}/ai/dialogues/${currentDialogueId}/messages/stream`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: parseInt(uid),
                        content: text
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let assistantMsgDiv = addMessage('assistant', '');
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    // SSE æ ¼å¼é€šå¸¸æ˜¯ "event: ...\ndata: ...\n\n"
                    // è¿™é‡Œç®€å•è§£æ
                    const lines = (buffer + chunk).split('\n');
                    buffer = lines.pop(); // ä¿ç•™æœ€åä¸å®Œæ•´çš„ä¸€è¡Œ

                    let currentEvent = null;

                    for (const line of lines) {
                        if (line.startsWith('event: ')) {
                            currentEvent = line.substring(7).trim();
                        } else if (line.startsWith('data: ')) {
                            const dataStr = line.substring(6).trim();
                            if (!dataStr) continue;
                            
                            try {
                                const data = JSON.parse(dataStr);
                                handleEvent(currentEvent, data, assistantMsgDiv);
                            } catch (e) {
                                console.error("Parse error", e);
                            }
                        }
                    }
                }
            } catch (e) {
                console.error(e);
                addMessage('system', 'Error: ' + e);
            }
        }

        function handleEvent(event, data, msgDiv) {
            // åœ¨ interleaved æ¨¡å¼ä¸‹ï¼Œä¸éœ€è¦æ¯æ¬¡éƒ½æ¸…ç©ºæˆ–é‡ç½®ï¼Œç›´æ¥è¿½åŠ å³å¯
            // å› ä¸ºåç«¯å·²ç»ä¿è¯äº† text å’Œ card çš„å‘é€é¡ºåº
            
            if (event === 'partial_text') {
                // ç®€å•çš„æ–‡æœ¬è¿½åŠ 
                // ä¸ºäº†é¿å…å¡ç‰‡å‡ºç°åœ¨æ–‡æœ¬ä¸­é—´å¯¼è‡´çš„æ˜¾ç¤ºæ··ä¹±ï¼Œ
                // æˆ‘ä»¬æ¯æ¬¡æ”¶åˆ° partial_text éƒ½è¿½åŠ åˆ°ä¸€ä¸ªå½“å‰çš„æ–‡æœ¬èŠ‚ç‚¹ä¸­ã€‚
                // å¦‚æœä¸Šä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¡ç‰‡ï¼Œåˆ™æ–°å»ºä¸€ä¸ªæ–‡æœ¬èŠ‚ç‚¹ã€‚
                
                // ä½¿ç”¨ dataset è·Ÿè¸ªæœ€åä¸€ä¸ªå…ƒç´ çš„ç±»å‹ï¼Œæ¯”æ£€æŸ¥ lastElementChild æ›´å¯é 
                const lastType = msgDiv.dataset.lastElementType;
                
                let textContainer;
                if (!lastType || lastType === 'card') {
                    textContainer = document.createElement('div');
                    textContainer.className = 'content';
                    textContainer.style.whiteSpace = 'pre-wrap'; // ä¿ç•™æ¢è¡Œ
                    msgDiv.appendChild(textContainer);
                    msgDiv.dataset.lastElementType = 'text';
                } else {
                    textContainer = msgDiv.lastElementChild;
                }
                
                // data.delta æ˜¯å¢é‡ï¼Œdata.content æ˜¯å…¨é‡ï¼ˆåœ¨æŸäº›å®ç°ä¸­ï¼‰
                // æˆ‘ä»¬çš„åç«¯ OutputManager ç°åœ¨çš„ stream_text é‡Œçš„ data.content å…¶å®æ˜¯ delta
                // ä½†ä¸ºäº†ä¿é™©ï¼Œæˆ‘ä»¬ä¼˜å…ˆç”¨ delta
                const textContent = data.delta !== undefined ? data.delta : data.content;
                textContainer.textContent += textContent || ""; 
                
            } else if (event === 'cards') {
                const cards = data.cards;
                cards.forEach(card => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card';
                    
                    // Render based on card type
                    let contentHtml = '';
                    const d = card.data;
                    
                    if (card.type === 1) { // Create Task
                        contentHtml = `
                            <div style="border-left: 3px solid #4CAF50; padding-left: 10px;">
                                <h4 style="margin: 0 0 5px 0; color: #2E7D32;">ğŸ†• åˆ›å»ºä»»åŠ¡</h4>
                                <div><strong>æ ‡é¢˜:</strong> ${d.title}</div>
                                ${d.description ? `<div><strong>æè¿°:</strong> ${d.description}</div>` : ''}
                                ${d.due_date ? `<div><strong>æˆªæ­¢:</strong> ${d.due_date}</div>` : ''}
                                ${d.assigned_date ? `<div><strong>åˆ†é…æ—¥æœŸ:</strong> ${d.assigned_date}</div>` : ''}
                                ${d.assigned_start_time ? `<div><strong>æ—¶é—´:</strong> ${d.assigned_start_time} - ${d.assigned_end_time || ''}</div>` : ''}
                                ${d.tags && d.tags.length ? `<div><strong>æ ‡ç­¾:</strong> ${d.tags.join(', ')}</div>` : ''}
                                ${d.record_result ? `<div><strong>éœ€è®°å½•ç»“æœ:</strong> æ˜¯</div>` : ''}
                                ${d.result ? `<div><strong>ç»“æœ:</strong> ${d.result}</div>` : ''}
                                ${d.long_term_task_id ? `<div><strong>å…³è”é•¿æœŸä»»åŠ¡ID:</strong> ${d.long_term_task_id}</div>` : ''}
                            </div>`;
                    } else if (card.type === 2) { // Delete / Confirm
                        contentHtml = `
                            <div style="border-left: 3px solid #F44336; padding-left: 10px;">
                                <h4 style="margin: 0 0 5px 0; color: #C62828;">âš ï¸ ç¡®è®¤åˆ é™¤</h4>
                                <div><strong>${d.title}</strong></div>
                                <div>${d.description}</div>
                                ${d.task_id ? `<div><strong>ä»»åŠ¡ID:</strong> ${d.task_id}</div>` : ''}
                            </div>`;
                    } else if (card.type === 3) { // Update Task
                        let diffHtml = '';
                        const formatVal = (key, val) => {
                            if (key === 'status') return val === 1 ? 'å¾…åŠ' : (val === 3 ? 'å®Œæˆ' : val);
                            if (val === null || val === undefined) return '(ç©º)';
                            if (typeof val === 'object') return JSON.stringify(val);
                            return val;
                        };
                        
                        // Compare original and updated
                        for (let key in d.updated) {
                            if (key === 'id' || key === 'user_id' || key === 'created_at' || key === 'updated_at') continue; // Skip metadata
                            const oldVal = d.original[key];
                            const newVal = d.updated[key];
                            
                            // Simple equality check (works for primitives and simple lists if stringified match)
                            if (JSON.stringify(oldVal) !== JSON.stringify(newVal)) {
                                diffHtml += `
                                    <div style="margin-top: 5px; border-bottom: 1px solid #eee; padding-bottom: 5px;">
                                        <div style="font-weight: bold; color: #555; font-size: 0.9em;">${key}</div>
                                        <div style="display: flex; gap: 10px;">
                                            <div style="flex: 1; color: #d32f2f; background: #ffebee; padding: 2px; font-size: 0.9em;"><span style="user-select:none">- </span>${formatVal(key, oldVal)}</div>
                                            <div style="flex: 1; color: #388e3c; background: #e8f5e9; padding: 2px; font-size: 0.9em;"><span style="user-select:none">+ </span>${formatVal(key, newVal)}</div>
                                        </div>
                                    </div>`;
                            }
                        }
                        
                        if (!diffHtml) diffHtml = '<div>æ²¡æœ‰æ£€æµ‹åˆ°å˜æ›´</div>';

                        contentHtml = `
                            <div style="border-left: 3px solid #2196F3; padding-left: 10px;">
                                <h4 style="margin: 0 0 5px 0; color: #1565C0;">ğŸ“ æ›´æ–°ä»»åŠ¡</h4>
                                <div><strong>ID:</strong> ${d.original.id}</div>
                                <div style="margin-top: 5px;">
                                    ${diffHtml}
                                </div>
                            </div>`;
                    } else if (card.type === 4) { // Create Long Term Task
                        contentHtml = `
                            <div style="border-left: 3px solid #9C27B0; padding-left: 10px;">
                                <h4 style="margin: 0 0 5px 0; color: #7B1FA2;">ğŸš€ åˆ›å»ºé•¿æœŸä»»åŠ¡</h4>
                                <div><strong>æ ‡é¢˜:</strong> ${d.title}</div>
                                ${d.description ? `<div><strong>æè¿°:</strong> ${d.description}</div>` : ''}
                                ${d.start_date ? `<div><strong>å¼€å§‹æ—¥æœŸ:</strong> ${d.start_date}</div>` : ''}
                                ${d.due_date ? `<div><strong>æˆªæ­¢æ—¥æœŸ:</strong> ${d.due_date}</div>` : ''}
                                ${d.progress !== undefined ? `<div><strong>è¿›åº¦:</strong> ${(d.progress * 100).toFixed(0)}%</div>` : ''}
                                ${d.sub_task_ids ? `<div><strong>å­ä»»åŠ¡:</strong> <pre>${JSON.stringify(d.sub_task_ids, null, 2)}</pre></div>` : ''}
                            </div>`;
                    } else if (card.type === 7) { // Update Journal
                        contentHtml = `
                            <div style="border-left: 3px solid #FF9800; padding-left: 10px;">
                                <h4 style="margin: 0 0 5px 0; color: #EF6C00;">ğŸ“” æ›´æ–°æ—¥è®°</h4>
                                <div><strong>æ—¥æœŸ:</strong> ${d.before.date}</div>
                                <div style="display: flex; gap: 10px; margin-top: 5px;">
                                    <div style="flex: 1; background: #fff3e0; padding: 5px;">
                                        <div style="font-size: 0.8em; color: #666;">ä¿®æ”¹å‰</div>
                                        <div style="white-space: pre-wrap;">${d.before.content || '(ç©º)'}</div>
                                    </div>
                                    <div style="flex: 1; background: #fff8e1; padding: 5px;">
                                        <div style="font-size: 0.8em; color: #666;">ä¿®æ”¹å</div>
                                        <div style="white-space: pre-wrap;">${d.after.content}</div>
                                    </div>
                                </div>
                            </div>`;
                    } else {
                        // Generic Fallback
                        contentHtml = `<strong>å¡ç‰‡ (Type ${card.type})</strong><br><pre>${JSON.stringify(card.data, null, 2)}</pre>`;
                    }
                    
                    cardDiv.innerHTML = contentHtml;
                    
                    if (card.user_confirmation) {
                        const statusDiv = document.createElement('div');
                        statusDiv.style.marginTop = "5px";
                        statusDiv.style.fontWeight = "bold";
                        if (card.user_confirmation === 'Y') {
                            statusDiv.style.color = "green";
                            statusDiv.textContent = "å·²ç¡®è®¤ (Y)";
                        } else {
                            statusDiv.style.color = "red";
                            statusDiv.textContent = "å·²å–æ¶ˆ (N)";
                        }
                        cardDiv.appendChild(statusDiv);
                    } else if (card.action_id) {
                        const actionsDiv = document.createElement('div');
                        actionsDiv.style.marginTop = "5px";

                        const btnConfirm = document.createElement('button');
                        btnConfirm.textContent = "âœ… ç¡®è®¤";
                        btnConfirm.onclick = () => confirmAction(card.action_id, actionsDiv);
                        
                        const btnCancel = document.createElement('button');
                        btnCancel.textContent = "âŒ å–æ¶ˆ";
                        btnCancel.onclick = () => cancelAction(card.action_id, actionsDiv);
                        
                        actionsDiv.appendChild(btnConfirm);
                        actionsDiv.appendChild(btnCancel);
                        cardDiv.appendChild(actionsDiv);
                    }
                    
                    msgDiv.appendChild(cardDiv);
                });
                msgDiv.dataset.lastElementType = 'card';
            } else if (event === 'error') {
                msgDiv.innerHTML += `<br><span style="color:red">Error: ${data.message}</span>`;
            }
            
            // æ»šåŠ¨åˆ°åº•éƒ¨
            const history = document.getElementById('chat-history');
            history.scrollTop = history.scrollHeight;
        }

        function addMessage(role, text) {
            const history = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `message ${role}`;
            if (role === 'user') div.textContent = text;
            if (role === 'system') div.innerHTML = `<i>${text}</i>`;
            history.appendChild(div);
            history.scrollTop = history.scrollHeight;
            return div;
        }

        async function confirmAction(actionId, container) {
            if(container) container.innerHTML = "â³ ç¡®è®¤ä¸­...";
            try {
                await fetch(`${API_BASE}/ai/actions/${actionId}/confirm`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: 1 })
                });
                if(container) {
                    container.innerHTML = '<span style="color: green; font-weight: bold;">å·²ç¡®è®¤ (Y)</span>';
                } else {
                    alert("å·²ç¡®è®¤");
                }
            } catch (e) { 
                alert(e); 
                if(container) container.innerHTML = "âŒ å¤±è´¥";
            }
        }

        async function cancelAction(actionId, container) {
            if(container) container.innerHTML = "â³ å–æ¶ˆä¸­...";
            try {
                await fetch(`${API_BASE}/ai/actions/${actionId}/cancel`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: 1 })
                });
                if(container) {
                    container.innerHTML = '<span style="color: red; font-weight: bold;">å·²å–æ¶ˆ (N)</span>';
                } else {
                    alert("å·²å–æ¶ˆ");
                }
            } catch (e) { 
                alert(e); 
                if(container) container.innerHTML = "âŒ å¤±è´¥";
            }
        }

        function simulateCards() {
            const msgDiv = addMessage('assistant', '');
            
            // 1. Create Task
            handleEvent('partial_text', { content: "å¥½çš„ï¼Œæˆ‘æ¥å¸®ä½ åˆ›å»ºä»»åŠ¡ã€‚\n" }, msgDiv);
            handleEvent('cards', { cards: [{
                type: 1,
                data: { 
                    title: "ä¹°ç‰›å¥¶", 
                    description: "å»è¶…å¸‚ä¹°å…¨è„‚ç‰›å¥¶", 
                    due_date: "2023-12-31",
                    tags: ["ç”Ÿæ´»", "è´­ç‰©"],
                    record_result: true
                },
                action_id: "sim-1",
                user_confirmation: "Y"
            }]}, msgDiv);
            
            // 2. Delete Task
            handleEvent('partial_text', { content: "\næ¥ä¸‹æ¥åˆ é™¤æ—§ä»»åŠ¡ã€‚\n" }, msgDiv);
            handleEvent('cards', { cards: [{
                type: 2,
                data: { title: "ç¡®è®¤åˆ é™¤ä»»åŠ¡: ä¹°é¸¡è›‹", description: "ID: 101", task_id: 101 },
                action_id: "sim-2",
                user_confirmation: "N"
            }]}, msgDiv);
            
            // 3. Update Task
            handleEvent('partial_text', { content: "\nç„¶åæ›´æ–°ä¸€ä¸‹ä¼šè®®æ—¶é—´ã€‚\n" }, msgDiv);
            handleEvent('cards', { cards: [{
                type: 3,
                data: { 
                    original: { id: 102, title: "å‘¨ä¼š", status: 1, due_date: "2023-10-27 10:00" },
                    updated: { id: 102, title: "å‘¨ä¼š (æ”¹æœŸ)", status: 3, due_date: "2023-10-28 10:00" }
                },
                action_id: "sim-3"
            }]}, msgDiv);
            
            // 4. Create Long Term Task
            handleEvent('partial_text', { content: "\nåˆ›å»ºä¸€ä¸ªé•¿æœŸå­¦ä¹ è®¡åˆ’ã€‚\n" }, msgDiv);
            handleEvent('cards', { cards: [{
                type: 4,
                data: { 
                    title: "å­¦ä¹ é’¢ç´", 
                    description: "ä»é›¶å¼€å§‹å­¦ä¹ ",
                    start_date: "2023-11-01",
                    progress: 0.0,
                    sub_task_ids: {"103": 0.5, "104": 0.5} 
                },
                action_id: "sim-4"
            }]}, msgDiv);
            
            // 7. Update Journal
            handleEvent('partial_text', { content: "\næœ€åæ›´æ–°ä»Šå¤©çš„æ—¥è®°ã€‚\n" }, msgDiv);
            handleEvent('cards', { cards: [{
                type: 7,
                data: { 
                    before: { date: "2023-10-27", content: "ä»Šå¤©å¤©æ°”ä¸é”™ã€‚" },
                    after: { date: "2023-10-27", content: "ä»Šå¤©å¤©æ°”ä¸é”™ï¼Œè¿˜å»å…¬å›­è·‘äº†æ­¥ã€‚" }
                },
                action_id: "sim-7"
            }]}, msgDiv);
            
            handleEvent('partial_text', { content: "\næ¼”ç¤ºå®Œæ¯•ã€‚" }, msgDiv);
        }
    </script>
</body>
</html>
