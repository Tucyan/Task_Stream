
---

## 1. 用户表（User）

| 字段名         | 类型         | 约束           | 说明         |
| -------------- | ------------ | -------------- | ------------ |
| id             | INTEGER      | PRIMARY KEY    | 用户ID       |
| username       | TEXT         | NOT NULL UNIQUE| 用户名       |
| created_at     | TEXT         | NOT NULL       | 创建时间     |
| name           | TEXT         |                | 昵称         |
| passwordHash   | TEXT         | NOT NULL       | 密码哈希值   |


---

### 2. 任务表（Task）

| 字段名              | 类型         | 约束           | 说明         |
| ------------------- | ------------ | -------------- | ------------ |
| id                  | INTEGER      | PRIMARY KEY    | 任务ID       |
| user_id             | INTEGER      | NOT NULL       | 用户ID（外键）|
| title               | TEXT         | NOT NULL       | 任务标题     |
| description         | TEXT         |                | 任务描述     |
| status              | INTEGER      | NOT NULL       | 状态（1:todo, 2:in_progress, 3:done）|
| due_date            | TEXT         |                | 截止时间"YYYY-MM-DD HH-MM"|
| created_at          | TEXT         | NOT NULL       | 创建时间     |
| updated_at          | TEXT         | NOT NULL       | 更新时间     |
| assigned_date       | TEXT         |                | 分配日期"YYYY-MM-DD"，默认为创建日期|
| assigned_start_time | TEXT         |                | 分配开始时间"HH-MM"|
| assigned_end_time   | TEXT         |                | 分配结束时间"HH-MM"|
| tags                | TEXT         |                | 标签（JSON字符串，最多3个，每个≤10字符）|
| record_result       | INTEGER      | DEFAULT 0      | 是否记录成果（0/1）|
| result              | TEXT         |                | 成果描述     |
| result_picture_url  | TEXT         |                | 成果图片URL（JSON字符串数组）|
| long_term_task_id   | INTEGER      |                | 关联的长期任务ID（外键）|

---

### 3. 长期任务表（LongTermTask）

| 字段名      | 类型         | 约束           | 说明         |
| ----------- | ------------ | -------------- | ------------ |
| id          | INTEGER      | PRIMARY KEY    | 长期任务ID   |
| user_id     | INTEGER      | NOT NULL       | 用户ID（外键）|
| title       | TEXT         | NOT NULL       | 长期任务标题 |
| description | TEXT         |                | 长期任务描述 |
| start_date  | TEXT         |                | 开始日期     |
| due_date    | TEXT         |                | 截止时间"YYYY-MM-DD HH-MM"    |
| progress    | REAL         | NOT NULL       | 进度百分比（0.0~1.0）|
| created_at  | TEXT         | NOT NULL       | 创建时间     |
| updated_at  | TEXT         | NOT NULL       | 更新时间，格式为yyyy-MM-dd HH:mm，默认为当前时间 |
| last_reminder_time | TEXT |                | 上次提醒时间，格式为yyyy-MM-dd HH:mm，可以为空 |
| sub_task_ids| TEXT         |                | 子任务ID和权重的字典（JSON格式: {"task_id": weight}，例如 {"1": 0.7, "2": 0.3}|


---

### 4. 日志表（Journal）

| 字段名   | 类型         | 约束           | 说明         |
| -------- | ------------ | -------------- | ------------ |
| date     | TEXT         | NOT NULL   | 日志日期（YYYY-MM-DD）|
| user_id  | INTEGER      | NOT NULL       | 用户ID（外键）|
| content  | TEXT         | NOT NULL       | 日志内容     |
| main_key |         | PRIMARY KEY(date, user_id) | 联合主键 |


---

### 5. AI助手消息表(AIAssistantMessage)

| 字段名    | 类型         | 约束           | 说明         |
| --------- | ------------ | -------------- | ------------ |
| id        | INTEGER      | PRIMARY KEY    | 消息ID       |
| user_id   | INTEGER      | NOT NULL       | 用户ID（外键）|
| title     | TEXT         |                | 会话标题     |
| timestamp | TEXT         | NOT NULL       | 消息时间戳   |
| messages  | TEXT         | NOT NULL       | 消息内容（JSON 字符串数组，元素为消息对象，见下方说明）|
---

#### messages 字段格式说明

`messages` 字段以 JSON 字符串形式存储整段对话内容。反序列化后为：

- 类型：`ChatTurn[][]`
- 外层数组：按时间顺序存储多轮对话，每一轮为一个 `ChatTurn[]`
- `ChatTurn` 结构示意：
  - `role`: `"user"`、`"assistant"` 或 `"error"`
  - `content`:
    - 对于 `"user"`：字符串文本（用户的原始输入）
    - 对于 `"assistant"`：可以是简单字符串，或由多个卡片对象组成的数组（卡片对象结构见下方 `type` 定义）
    - 对于 `"error"`：字符串文本（错误信息）

卡片对象的基本结构：

- `type`: 整数，取值 `0~7`，表示消息展示类型
- `data`: 对象，具体结构由 `type` 决定

`type` 与含义、数据内容对应关系如下：

- `0` 常规文本  
  - `data` 中至少包含：`content` 文本内容
- `1` 新建任务卡片  
  - 内容：任务名称、任务描述、任务时间、任务时间段（可选）、截止日期（可选）、分配日期（可选）  
  - 交互：根据 AI 设置决定是否显示“确定/取消”按钮（不显示则自动确认创建）
- `2` 长期任务卡片  
  - 内容：长期任务名称、描述、截止时间（可选）、子任务列表（仅显示标题，可为空）
- `3` diff 任务卡片（在更改任务时显示）  
  - 内容：同时展示用户更改前和更改后的任务信息，两张任务卡片在电脑端并排显示、在手机端上下显示；修改后的任务卡片在下面或右边  
  - 字段：任务名称、任务描述、任务时间、任务时间段（可选）、截止日期（可选）、分配日期（可选），以及任务 `id`  
  - 要求：修改前和修改后的差异内容需加粗标出（两边都标注）  
  - 交互：显示确认和取消按钮（不显示则自动确认更改）
- `4` diff 长期任务卡片（在更改长期任务时显示）  
  - 内容：同时展示用户更改前和更改后的长期任务信息，两张长期任务卡片在电脑端并排显示、在手机端上下显示；修改后的长期任务卡片在下面或右边  
  - 字段：长期任务名称、描述、截止时间（可选）、子任务列表（仅显示标题和权重，可为空），以及长期任务 `id`  
  - 交互：显示确认和取消按钮（不显示则自动确认更改）
- `5` 删除列表卡片  
  - 内容：用户删除的任务标题列表，可以点击标题查看任务详细信息（详细信息以弹窗形式展示）  
  - 在详细信息弹窗中可以“取消删除”该任务，返回列表后该项以删除线展示（表示不删除，但可在详情中再次点击“删除”）  
  - 字段：每个待删除任务需包含 `id` 和 `title`，以便前端/后端准确标识  
  - 交互：显示确认和取消按钮（不显示则自动确认删除）
- `6` 提醒卡片  
  - 内容：提醒类型（消息/任务/长期任务）、提醒时间、提醒内容，以及可选的关联任务 `task_id`  
  - 交互：显示确认和取消按钮（不显示则自动确认提醒）
- `7` 日志修改卡片  
  - 内容：展示用户修改前后的日志内容（Journal），支持差异高亮  
  - 字段：包括日志日期 `date`、用户ID `user_id`，以及修改前后的 `content` 文本  
  - 交互：显示确认和取消按钮（不显示则自动确认更改）


#### messages 字段 JSON 字符串示例

下面是一个包含 0~7 各种卡片类型的示例（反序列化后的 JSON 结构）：

```json
[
  [
    {
      "role": "user",
      "content": "此处为用户的要求"
    },
    {
      "role": "assistant",
      "content": [
        {
          "type": 0,
          "data": {
            "content": "你好，我是你的任务助手。"
          }
        },
        {
          "type": 1,
          "user_confirmation": "Y",
          "data": {
            "title": "撰写周报",
            "description": "整理本周项目进展并发送给负责人",
            "assigned_date": "2025-12-14",
            "assigned_start_time": "09:00",
            "assigned_end_time": "10:00",
            "due_date": "2025-12-15 18:00",
            "tags": ["工作", "汇报"]
          }
        },
        {
          "type": 2,
          "user_confirmation": "N",
          "data": {
            "title": "英语学习计划",
            "description": "三个月内提升口语流利度",
            "due_date": "2026-03-01 00:00",
            "sub_tasks": [
              { "title": "每天背单词", "weight": 0.4 },
              { "title": "每周口语练习", "weight": 0.6 }
            ]
          }
        },
        {
          "type": 3,
          "user_confirmation": "Y",
          "data": {
            "before": {
              "id": 101,
              "title": "原始任务标题",
              "description": "原始任务描述",
              "assigned_date": "2025-12-14",
              "assigned_start_time": "09:00",
              "assigned_end_time": "10:00",
              "due_date": "2025-12-15 18:00"
            },
            "after": {
              "id": 101,
              "title": "**原始任务标题（加急）**",
              "description": "**原始任务描述：增加了本周需要完成的内容**",
              "assigned_date": "2025-12-14",
              "assigned_start_time": "09:00",
              "assigned_end_time": "11:00",
              "due_date": "2025-12-16 18:00"
            }
          }
        },
        {
          "type": 4,
          "user_confirmation": "Y",
          "data": {
            "before": {
              "id": 201,
              "title": "原始长期任务",
              "description": "原始长期任务描述",
              "due_date": "2026-01-01 00:00",
              "sub_tasks": [
                { "title": "子任务A", "weight": 0.5 },
                { "title": "子任务B", "weight": 0.5 }
              ]
            },
            "after": {
              "id": 201,
              "title": "**原始长期任务**",
              "description": "**长期任务描述：调整了目标范围**",
              "due_date": "2026-02-01 00:00",
              "sub_tasks": [
                { "title": "子任务A", "weight": 0.4 },
                { "title": "子任务B", "weight": 0.3 },
                { "title": "子任务C", "weight": 0.3 }
              ]
            }
          }
        },
        {
          "type": 5,
          "user_confirmation": "Y",
          "data": {
            "tasks": [
              { "id": 301, "title": "删除测试任务 A" },
              { "id": 302, "title": "删除测试任务 B" }
            ]
          }
        },
        {
          "type": 6,
          "user_confirmation": "Y",
          "data": {
            "reminder_type": "Task",
            "time": "2025-12-14 20:00",
            "content": "回顾今天完成的任务并记录成果",
            "task_id": 123
          }
        },
        {
          "type": 7,
          "user_confirmation": "Y",
          "data": {
            "before": {
              "date": "2025-12-14",
              "user_id": 1,
              "content": "原始日志内容"
            },
            "after": {
              "date": "2025-12-14",
              "user_id": 1,
              "content": "**修改后的日志内容：补充了今天完成的任务**"
            }
          }
        }
      ]
    }
  ]
]
```

数据库中实际存储在 `messages` 字段里的内容是上面整个 JSON 结构经 `JSON.stringify` 之后的**字符串形式**。

其中：

- 应用程序读写数据库时，需要在字符串和 JSON 对象之间进行序列化/反序列化；
- 示例中仅展示了常见字段，实际实现时可以在 `data` 内扩展字段，但必须保证 `type` 与上表含义保持一致。


## 6. 设置表（Settings）

| 字段名      | 类型     | 约束                | 说明                   |
| ----------- | -------- | ------------------- | ---------------------- |
| id          | INTEGER  | PRIMARY KEY         | 设置ID                 |
| user_id     | INTEGER  | NOT NULL            | 用户ID（外键）         |
| primary     | TEXT     | NOT NULL            | 强调色（HEX色值）      |
| bg          | TEXT     | NOT NULL            | 背景色（HEX色值）      |
| card        | TEXT     | NOT NULL            | 卡片色（HEX色值）      |
| text        | TEXT     | NOT NULL            | 文字色（HEX色值）      |
| theme_mode  | TEXT     | DEFAULT 'light'     | 主题模式（light/dark） |

---

### 7. AI总表（AIConfig）

| 字段名 | 类型 | 约束 | 说明 |
|---|---|---|---|
|id|INTEGER|PRIMARY KEY|主键|
|user_id|INTEGER|NOT NULL|用户id|
|api_key|TEXT|NOT NULL|用户的api-key|
|model|TEXT|NOT NULL|用户选择的模型|
|prompt|TEXT| |用户输入的提示词|
|character|TEXT| |用户选择的性格|
|long_term_memory|TEXT| |用户输入的长期固定记忆|
|ai_dialogue_id_list|TEXT| |用户与AI助手的对话id列表，逗号分隔记录AIAssistantMessage的主键(id)|
|is_enable_prompt|INTEGER|NOT NULL DEFAULT 0|是否启用prompt(0/1)|
|is_auto_confirm_create_request|INTEGER|NOT NULL DEFAULT 0|是否自动确认创建请求(0/1)|
|is_auto_confirm_update_request|INTEGER|NOT NULL DEFAULT 0|是否自动确认更改请求(0/1)|
|is_auto_confirm_delete_request|INTEGER|NOT NULL DEFAULT 0|是否自动确认删除请求(0/1)|
|is_auto_confirm_create_reminder|INTEGER|NOT NULL DEFAULT 0|是否自动确认新建提醒(0/1)|
|reminder_list|TEXT| |提醒列表(根据提醒时间升序排序，在新建的时候维护提醒时间顺序)，格式参考[{"type":"Message","time":"2023-08-01 12:00","content":"提醒内容"},{"type":"Task","time":"2023-08-01 18:00","content":"提醒内容","task_id":1},{"type":"LongTermTask","time":"2023-08-01 20:00","content":"提醒内容","task_id":1}]|

  这里格式参考放到外面
