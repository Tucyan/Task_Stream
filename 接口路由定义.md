# Task Stream 接口与路由定义

> 本文档汇总当前项目中已实现的所有 HTTP 接口（后端路由 + 前端封装函数），并补充 AI 助手与流式对话相关的接口设计草案，供后续实现时参考与对齐。

---

## 一、通用约定

- 后端基础地址：`http://localhost:8000`（或由 `VITE_API_BASE_URL` 指定）  
- 统一前缀：`/api/v1`  
- 前端统一封装：`src/services/api.js`  
- 后端主入口：`backend/app/main.py`  

---

## 二、任务模块（Task）

### 1. 获取任务列表（支持日期范围）

- 方法与路径：`GET /api/v1/tasks/`
- 查询参数：
  - `user_id` `int` 必填，用户 ID
  - `start_date` `string` 可选，开始日期 `YYYY-MM-DD`
  - `end_date` `string` 可选，结束日期 `YYYY-MM-DD`
- 说明：
  - 同时提供 `start_date` 与 `end_date` 时，返回该日期区间内任务；
  - 否则返回该用户所有任务。
- 后端实现：
  - 控制器：`backend/app/main.py:60` `read_tasks`
  - 数据访问：`crud.get_tasks_in_date_range`、`crud.get_all_tasks_for_user`
- 前端封装：
  - `getTasksInDateRange(startDate, endDate, userId)` 调用  
    `GET /api/v1/tasks?start_date=${startDate}&end_date=${endDate}&user_id=${userId}`  
    定义于：`src/services/api.js:100`
  - `getAllTasksForUser(userId)` 调用  
    `GET /api/v1/tasks?user_id=${userId}`  
    定义于：`src/services/api.js:109`

### 2. 获取急需处理任务列表

- 方法与路径：`GET /api/v1/tasks/urgent`
- 查询参数：
  - `user_id` `int` 必填，用户 ID
- 返回：长期任务 + 普通任务混合列表，按截止时间升序。元素包含：`id`、`title`、`due_date`、`type`。
- 后端实现：
  - 控制器：`backend/app/main.py:50` `get_urgent_tasks`
  - 数据访问：`crud.get_urgent_tasks`
- 前端封装：
  - `getUrgentTasks(userId)`  
    定义于：`src/services/api.js:131`

### 3. 创建任务

- 方法与路径：`POST /api/v1/tasks/`
- 请求体：`schemas.TaskCreate`（参考任务表定义）
- 后端实现：
  - 控制器：`backend/app/main.py:76` `create_task`
  - 数据访问：`crud.create_task`
- 前端封装：
  - `createTask(taskData)`  
    定义于：`src/services/api.js:142`

### 4. 获取单个任务

- 方法与路径：`GET /api/v1/tasks/{task_id}`
- 路径参数：
  - `task_id` `int` 任务 ID
- 后端实现：
  - 控制器：`backend/app/main.py:83` `get_task_by_id`
- 前端封装：
  - `getTaskById(taskId)`  
    定义于：`src/services/api.js:165`

### 5. 更新任务

- 方法与路径：`PUT /api/v1/tasks/{task_id}`
- 路径参数：
  - `task_id` `int` 任务 ID
- 请求体：`schemas.Task`（完整任务对象）
- 后端实现：
  - 控制器：`backend/app/main.py:107` `update_task`
  - 数据访问：`crud.update_task`
- 前端封装：
  - `updateTask(taskId, taskData)`  
    定义于：`src/services/api.js:184`

### 6. 删除任务

- 方法与路径：`DELETE /api/v1/tasks/{task_id}`
- 路径参数：
  - `task_id` `int` 任务 ID
- 后端实现：
  - 控制器：`backend/app/main.py:96` `delete_task`
  - 数据访问：`crud.delete_task`
- 前端封装：
  - `deleteTask(taskId)`  
    定义于：`src/services/api.js:154`

---

## 三、长期任务模块（LongTermTask）

### 1. 获取指定用户的所有长期任务

- 方法与路径：`GET /api/v1/long-term-tasks`
- 查询参数：
  - `user_id` `int` 必填
- 后端实现：
  - 控制器：`backend/app/main.py:124` `read_all_long_term_tasks`
  - 数据访问：`crud.get_all_long_term_tasks`
- 前端封装：
  - `getAllLongTermTasks(userId)`  
    定义于：`src/services/api.js:118`

### 2. 获取指定用户所有未完成长期任务

- 方法与路径：`GET /api/v1/long-term-tasks/uncompleted`
- 查询参数：
  - `user_id` `int` 必填
- 后端实现：
  - 控制器：`backend/app/main.py:152` `read_all_uncompleted_long_term_tasks`
  - 数据访问：`crud.get_all_uncompleted_long_term_tasks`
- 前端封装：
  - `getAllUncompletedLongTermTasks(userId)`  
    定义于：`src/services/api.js:127`

### 3. 获取单个长期任务

- 方法与路径：`GET /api/v1/long-term-tasks/{task_id}`
- 路径参数：
  - `task_id` `int` 长期任务 ID
- 后端实现：
  - 控制器：`backend/app/main.py:163` `read_long_term_task`
- 前端封装：
  - `getLongTermTaskById(taskId)`  
    定义于：`src/services/api.js:174`

### 4. 创建长期任务

- 方法与路径：`POST /api/v1/long-term-tasks`
- 请求体：`schemas.LongTermTaskCreate`
- 后端实现：
  - 控制器：`backend/app/main.py:134` `create_long_term_task`
  - 数据访问：`crud.create_long_term_task`
- 前端封装：
  - `createLongTermTask(taskData)`  
    定义于：`src/services/api.js:196`

### 5. 更新长期任务

- 方法与路径：`PUT /api/v1/long-term-tasks/{task_id}`
- 路径参数：
  - `task_id` `int` 长期任务 ID
- 请求体：`schemas.LongTermTask`
- 后端实现：
  - 控制器：`backend/app/main.py:177` `update_long_term_task`
  - 数据访问：`crud.update_long_term_task`
- 前端封装：
  - `updateLongTermTask(taskId, taskData)`  
    定义于：`src/services/api.js:220`

### 6. 删除长期任务

- 方法与路径：`DELETE /api/v1/long-term-tasks/{task_id}`
- 路径参数：
  - `task_id` `int` 长期任务 ID
- 后端实现：
  - 控制器：`backend/app/main.py:141` `delete_long_term_task`
  - 数据访问：`crud.delete_long_term_task`
- 前端封装：
  - `deleteLongTermTask(taskId)`  
    定义于：`src/services/api.js:208`

---

## 四、日记模块（Journal）

### 1. 获取某月有日记的日期列表

- 方法与路径：`GET /api/v1/journals/dates`
- 查询参数：
  - `year` `int` 年份
  - `month` `int` 月份
  - `user_id` `int` 用户 ID
- 后端实现：
  - 控制器：`backend/app/main.py:198` `get_journal_dates`
  - 数据访问：`crud.get_journal_dates`
- 前端封装：
  - `getJournalDates(year, month, userId)`  
    定义于：`src/services/api.js:259`

### 2. 获取某月日记状态列表

- 方法与路径：`GET /api/v1/journals/status`
- 查询参数：
  - `year` `int`
  - `month` `int`
  - `user_id` `int`
- 返回：`List[bool]`，按日期顺序标记当日是否有日记。
- 后端实现：
  - 控制器：`backend/app/main.py:211` `get_journal_status`
  - 数据访问：`crud.get_journal_status_list`
- 前端封装：
  - `getJournalStatus(year, month, userId)`  
    定义于：`src/services/api.js:270`

### 3. 获取指定日期日记

- 方法与路径：`GET /api/v1/journals/{date}`
- 路径参数：
  - `date` `string` 日期 `YYYY-MM-DD`
- 查询参数：
  - `user_id` `int` 用户 ID
- 返回：`schemas.Journal | null`
- 后端实现：
  - 控制器：`backend/app/main.py:225` `read_journal`
  - 数据访问：`crud.get_journal_by_date`
- 前端封装：
  - `getJournalByDate(date, userId)`  
    定义于：`src/services/api.js:233`

### 4. 更新指定日期日记内容

- 方法与路径：`PUT /api/v1/journals/{date}`
- 路径参数：
  - `date` `string` 日期 `YYYY-MM-DD`
- 请求体：
  - `content` `string` 日记内容
  - `user_id` `int` 用户 ID
- 后端实现：
  - Pydantic 模型：`JournalUpdate` 定义于 `backend/app/main.py:237`
  - 控制器：`backend/app/main.py:243` `update_journal_content_endpoint`
  - 数据访问：`crud.update_journal_content`
- 前端封装：
  - `updateJournalContent(date, content, userId)`  
    定义于：`src/services/api.js:244`

---

## 五、统计与热力图模块

### 1. 获取日记热力图数据

- 方法与路径：`GET /api/v1/stats/heatmap`
- 查询参数：
  - `year` `int`
  - `month` `int`
  - `user_id` `int`
- 返回：`List[int]` 热力图数据
- 后端实现：
  - 控制器：`backend/app/main.py:256` `read_heatmap_data`
  - 数据访问：`crud.get_heatmap_data`
- 前端封装：
  - `getHeatmapData(year, month, userId)`  
    定义于：`src/services/api.js:281`

---

## 六、用户认证模块（Auth）

统一路由前缀：`/api/v1/auth`，由 `backend/app/main.py:331` 注册 `app.services.auth.router`。

### 1. 用户注册

- 方法与路径：`POST /api/v1/auth/register`
- 请求体：
  - `username` `string`
  - `passwordHash` `string`（前端用 SHA256 计算）
  - `nickname` `string` 可选，若为空则使用 `username`
- 后端实现：
  - 控制器：`backend/app/services/auth.py:27` `register`
  - 请求模型：`RegisterRequest` 定义于 `backend/app/services/auth.py:22`
- 前端封装：
  - `register(username, password)`  
    定义于：`src/services/api.js:291`  
    内部通过 `hashPassword` 生成 `passwordHash`
  - `registerWithNickname(username, password, nickname)`  
    定义于：`src/services/api.js:328`

### 2. 用户登录

- 方法与路径：`POST /api/v1/auth/login`
- 请求体：
  - `username` `string`
  - `passwordHash` `string`
- 后端实现：
  - 控制器：`backend/app/services/auth.py:55` `login`
  - 请求模型：`LoginRequest` 定义于 `backend/app/services/auth.py:51`
- 前端封装：
  - `login(username, password)`  
    定义于：`src/services/api.js:312`

### 3. 修改密码

- 方法与路径：`PUT /api/v1/auth/password`
- 请求体：
  - `user_id` `int`
  - `current_password` `string`（明文）
  - `new_password` `string`（明文）
- 后端实现：
  - 控制器：`backend/app/services/auth.py:70` `update_password`
  - 请求模型：`UpdatePasswordRequest` 定义于 `backend/app/services/auth.py:65`
- 前端封装：
  - `updatePassword(userId, currentPassword, newPassword)`  
    定义于：`src/services/api.js:344`

### 4. 修改昵称

- 方法与路径：`PUT /api/v1/auth/nickname`
- 请求体：
  - `user_id` `int`
  - `new_nickname` `string`
- 后端实现：
  - 控制器：`backend/app/services/auth.py:90` `update_nickname`
  - 请求模型：`UpdateNicknameRequest` 定义于 `backend/app/services/auth.py:86`
- 前端封装：
  - `updateNickname(userId, newNickname)`  
    定义于：`src/services/api.js:362`

---

## 七、用户设置模块（Settings）

### 1. 获取用户设置

- 方法与路径：`GET /api/v1/settings/{user_id}`
- 路径参数：
  - `user_id` `int`
- 返回：`schemas.Settings | null`
- 后端实现：
  - 控制器：`backend/app/main.py:269` `read_settings`
  - 数据访问：`crud.get_settings_by_user_id`
- 前端封装：
  - `getSettings(userId)`  
    定义于：`src/services/api.js:391`

### 2. 创建用户设置

- 方法与路径：`POST /api/v1/settings`
- 请求体：`schemas.SettingsCreate`
- 后端实现：
  - 控制器：`backend/app/main.py:279` `create_settings`
  - 数据访问：`crud.create_settings`
  - 约束：同一用户仅允许一条设置记录，已有则返回 400
- 前端封装：
  - `createSettings(settingsData)`  
    定义于：`src/services/api.js:400`

### 3. 更新用户设置

- 方法与路径：`PUT /api/v1/settings/{user_id}`
- 路径参数：
  - `user_id` `int`
- 请求体：`schemas.SettingsUpdate`
- 后端实现：
  - 控制器：`backend/app/main.py:293` `update_settings`
  - 数据访问：`crud.update_settings`
- 前端封装：
  - `updateSettings(userId, settingsData)`  
    定义于：`src/services/api.js:413`

---

## 八、备忘录模块（Memo）

### 1. 获取用户备忘录

- 方法与路径：`GET /api/v1/memos/{user_id}`
- 路径参数：
  - `user_id` `int`
- 返回：`schemas.Memo | null`
- 后端实现：
  - 控制器：`backend/app/main.py:308` `read_memo`
  - 数据访问：`crud.get_memo`
- 前端封装：
  - `getMemo(userId)`  
    定义于：`src/services/api.js:425`

### 2. 更新用户备忘录

- 方法与路径：`PUT /api/v1/memos/{user_id}`
- 路径参数：
  - `user_id` `int`
- 请求体：
  - `content` `string`
- 后端实现：
  - 控制器：`backend/app/main.py:318` `update_memo`
  - 数据访问：`crud.update_memo`
- 前端封装：
  - `updateMemo(userId, content)`  
    定义于：`src/services/api.js:435`

---

## 九、AI 助手与对话模块（基于 LangChain Agent 设计）

本节基于 `AI功能逻辑设计.md`，定义 AI 助手相关接口。所有接口挂载于 `/api/v1/ai`。

### 1. 会话管理

#### 1.1 获取用户对话列表

- 方法与路径：`GET /api/v1/ai/dialogues`
- 查询参数：
  - `user_id` `int`
- 返回：对话列表，按最近更新时间逆序：
  - `id` `int`
  - `title` `string`
  - `last_timestamp` `string`

#### 1.2 获取指定对话的完整 messages

- 方法与路径：`GET /api/v1/ai/dialogues/{dialogue_id}`
- 路径参数：
  - `dialogue_id` `int`
- 查询参数：
  - `user_id` `int`
- 返回：
  - `id` `int`
  - `user_id` `int`
  - `title` `string`
  - `timestamp` `string`
  - `messages` `ChatTurn[][]`（与 `数据库定义文档.md` 一致）

#### 1.3 新建对话

- 方法与路径：`POST /api/v1/ai/dialogues`
- 请求体：
  - `user_id` `int`
  - `title` `string` 可选
- 返回：新建对话记录（含 `id`）。

#### 1.4 更新对话标题

- 方法与路径：`PUT /api/v1/ai/dialogues/{dialogue_id}/title`
- 路径参数：`dialogue_id` `int`
- 请求体：
  - `user_id` `int`
  - `title` `string`

#### 1.5 删除对话

- 方法与路径：`DELETE /api/v1/ai/dialogues/{dialogue_id}`
- 路径参数：`dialogue_id` `int`
- 查询参数：`user_id` `int`

### 2. AIConfig 配置接口

#### 2.1 获取用户 AI 配置

- 方法与路径：`GET /api/v1/ai/config/{user_id}`
- 返回：`AIConfig` 对象（含 api_key, model, prompt, character, 自动确认开关等）。

#### 2.2 更新用户 AI 配置

- 方法与路径：`PUT /api/v1/ai/config/{user_id}`
- 请求体：`AIConfig` 的部分字段。

### 3. AI 对话流式接口（SSE）

#### 3.1 发起一轮 AI 对话

- 方法与路径：`POST /api/v1/ai/dialogues/{dialogue_id}/messages/stream`
- 路径参数：`dialogue_id` `int`
- 请求体：
  - `user_id` `int`
  - `content` `string` 用户提问
  - `client_message_id` `string` 可选
- 响应：`text/event-stream`
- 事件类型：
  - `start`: `{ "dialogue_id": 1 }`
  - `partial_text`: `{ "content": "..." }`
  - `text_done`: `{ "content": "完整文本" }`
  - `cards`: `{ "cards": [ { "type": 1, "data": {...}, "action_id": "uuid" } ] }`
  - `error`: `{ "message": "..." }`
  - `end`: `{ "dialogue_id": 1 }`

### 4. 动作确认接口

用于处理卡片中带有 `action_id` 的操作（如创建任务确认）。

#### 4.1 确认操作

- 方法与路径：`POST /api/v1/ai/actions/{action_id}/confirm`
- 路径参数：`action_id` `string` (UUID)
- 请求体：`{ "user_id": 1 }`
- 行为：唤醒后端挂起的工具执行流程。

#### 4.2 取消操作

- 方法与路径：`POST /api/v1/ai/actions/{action_id}/cancel`
- 路径参数：`action_id` `string` (UUID)
- 请求体：`{ "user_id": 1 }`
- 行为：唤醒后端挂起的工具执行流程（标记为取消）。


---

## 十、首页智能欢迎模块（设计草案）

依据 `未完成的事项.md:190-213` 中的数据库与逻辑描述，定义首页欢迎词相关接口标准。

### 1. 获取首页欢迎词

- 方法与路径：`GET /api/v1/home/welcome/{user_id}`
- 返回：
  - `home_welcome` `string` 当前欢迎词
  - `last_update_time` `int` 时间戳
  - `is_enable_intelligent_welcome` `int` (0/1)

### 2. 刷新首页欢迎词（非流式）

- 方法与路径：`POST /api/v1/home/welcome/{user_id}/refresh`
- 请求体：
  - `force` `bool` 可选，是否忽略时间间隔强制刷新
- 行为：
  - 若距离 `last_update_time` 超过 `{update_interval}`（3 小时），或 `force = true`，后端根据当日任务完成情况和 `home_intelligent_assistant_prompt` 调用 LLM 生成新的简短欢迎词，更新数据库并返回。

### 3. 点击面板触发的流式问候

- 方法与路径：`POST /api/v1/home/welcome/{user_id}/stream`
- 请求体：
  - `home_welcome_content` `string` 上一次欢迎词
  - 其他上下文字段（如 `today_task_content`）由后端补全
- 响应：`text/event-stream`
- 行为：
  - 若距离上次更新时间小于 `{minimum_update_interval}`（12 秒），则不更新数据库，仅将 LLM 即兴生成的一段问候通过流式接口返回前端展示。

---

本文件中的「设计草案」部分目前尚未在代码中实现，后续实现时应保持：

- 与数据库表定义一致（见 `数据库定义文档.md`）；
- 与前端 AiAssistantView 渲染逻辑一致（见 `未完成的事项.md:69-105`）；
- 充分复用现有任务、长期任务、日记等业务接口，避免重复实现业务逻辑。

